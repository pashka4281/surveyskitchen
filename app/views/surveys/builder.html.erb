<% header("Questions builder", subheader: 'All changes here are automatically saved.') %>

<%= page_header t('surveys.builder.title', name: @survey.name), nomargin: true, default_survey_menu: true %>

<style type="text/css"><%= raw @survey.theme.to_css %></style>

<div id="survey_theme_select" class="page-sub-header">
	<span><%= t('surveys.builder.themes_select') %></span>
	<select id="theme-select">
		<optgroup label="<%= t('surveys.builder.themes_global') %>">
			<% for th in @themes_global %>
				<option value="<%= th.id %>" <%= 'selected="selected"' if @survey.theme_id == th.id%>><%= th.name %></option>
			<% end %>
		</optgroup>
		<optgroup label="<%= t('surveys.builder.themes_current') %>">
			<% for th in @themes_current %>
				<option value="<%= th.id %>" <%= 'selected="selected"' if @survey.theme_id == th.id%>><%= th.name %></option>
			<% end %>
		</optgroup>
	</select>
	<%= link_to t('surveys.builder.look_and_feel'), look_survey_path(@survey, page: 'logo'), class: 'btn small' %>
</div>

<div id="builder">
	<div class="row">
		<div id="toolbox-wrapper" class="column">
			<div class="sticky-anchor"></div>
			<div id="toolbox" class="stickyBar">
				<div id="tabs">
					<ul>
						<li><a href="#new-item-area">Добавить</a></li>
						<li><a href="#edit-item-area">Редактировать</a></li>
						<li><a href="#form-settings-area">Настройки опроса</a></li>
					</ul>
					<div id="new-item-area"><%= render '/survey_items/new' %></div>
					<div id="edit-item-area"></div>
					<div id="form-settings-area"></div>
				</div>
			
			</div>
		</div>
		<div id="build_list"  class="list column <%= "survey_theme_#{@survey.theme.id}" %>">
			<h2 id="title"><%= @survey.name %></h2>
			<div id="zero-item" class="survey_item">
	            <%= insert_button %>
	    	</div>
	    
	        <div id="no-items-area">
	        	<div id="work-area-texting" class="fifteen columns centered centr-text vspace-big">
	        		<h3><%= t('surveys.builder.working_area_1') %></h3>
	        		<h5><%= t('surveys.builder.working_area_2') %></h5>
	        		<button  class="small btn new-item-btn success">
				    	<i class="icon-list-add"></i> <%= t 'surveys.builder.new_item' %> <br>
				    </button>
	        	</div>
	    	</div>
	    	
	    	<ul id="survey-items-list">
		        <%- @survey.sorted_items.each do |i| -%>
		        	<%= render_survey_item(i) %>
		        <%- end -%>
	    	</ul>
		</div>
	</div>
</div>



<%= content_for :after_content do %>
<!-- New survey item modal -->
	<div class="modal hide item-form" id="newItemContainer">
		<a href="#" class="close"></a>
		<div id="new_survey_item">
			<div class="modal-header">
				<h3><%= t('surveys.builder.new_item_modal_title') %></h3>
			</div>
			<div class="modal-body">
				<%= render '/survey_items/new' %>
			</div>
		</div>
		<div id="newItem"></div>
		<div class="modal-footer">
			<button class="btn close"><%= t('survey_items.new.cancel_btn') %></button>
			<button class="btn success" id="doneNewItemBtn"><%= t('survey_items.new.done_btn') %></button>
		</div>
	</div>

<!-- edit survey item modal -->
	<div class="modal hide item-form" id="editItemContainer">
		<a href="#" class="close"></a>
		<div id="edit-question-id"></div>
		<div id="editItem"></div>
		<div class="modal-footer">
			<button class="btn close"><%= t('survey_items.new.cancel_btn') %></button>
			<button class="btn success" id="doneEditItemBtn"><%= t('survey_items.new.done_btn') %></button>
		</div>
	</div>

<!-- trashed survey items modal -->
	<div class="modal hide fade" id="trashedItemsContainer">
	  <div class="modal-header">
	    <a href="#" class="close"></a>
	    <h3><%= t('surveys.builder.trashbox_modal_title') %></h3>
	  </div>
	  <div class="modal-body"></div>
	  <div class="modal-footer">
	    <a href="#" class="btn close">Close</a>
	  </div>
	</div>
<% end %>

<%= content_for :sidebar do %>
<div>
	<div id="sticky-anchor"></div>
	<div id="stickyBar">
		<button class="btn btn-primary" id="cancel-btn">
	    	<i class="icon-cancel"></i> <%= t 'surveys.builder.cancel' %>
	    </button>
	    <button  id="new-item-btn" class="btn new-item-btn">
	    	<i class="icon-list-add"></i> <%= t 'surveys.builder.new_item' %> <br>
	    </button>

	    <button id="trashbox-btn" data-url="<%= trashbox_survey_path(@survey) %>" class="btn" data-target="#trashedItemsContainer" data-toggle="modal" role="button">
	    	<i class="icon-trash"></i> <%= t 'surveys.builder.trashbox' %> <span class="trash-cnt">(<%= @survey.items.trashed.count %>)</span>
	    </button>
	    <!-- <button class="btn btn-warning"><i class="icon-wrench"></i> Survey settings</button> -->
	    <button class="btn btn-warning" id="preview-btn"><i class="icon-eye"></i> <%= t 'surveys.builder.preview' %> </button>
	</div>
</div>

<% end %>


<%= content_for :js do %>
	<script>
		$('#tabs').tabs();

		$('.stickyBar').containedStickyScroll({
        duration: 200,
        unstick: true,
        closeChar: 'x' 
    });

		var $gallery = $( "#new-item-area" ),
	      $build_list = $( "#build_list" );

	 
	    // let the gallery items be draggable
		$dragg = $( "ul li", $gallery ).draggable({
			cancel: "a.ui-icon", // clicking an icon won't initiate dragging
			revert: "invalid", // when not dropped, the item will revert back to its initial position
			containment: "document",
			helper: "clone",
			cursor: "move"
			,connectToSortable: '#survey-items-list'
			//,refreshPositions: true
			,scroll:true,
			start: function(event, ui){
				console.log( $(this).offsetParent() )
				console.log( $(this).scrollTop() )
				//ui.helper.appendTo($('body')).css({'position': 'fixed', 'z-index': 9999});
				var st = $('body').scrollTop() == 0 ? $('html').scrollTop() : $('body').scrollTop();
		        $(this).data("startingScrollTop", st);
		    },  
		    drag: function(event, ui)
		    {
		        var st_old = parseInt($(this).data("startingScrollTop")),
		        	st = $('body').scrollTop() == 0 ? $('html').scrollTop() : $('body').scrollTop(),
		        	df = st_old -  st;
		        //ui.position.top -= $(this).offsetParent().scrollTop() - st;
		        //ui.position.top += df;
		    }
		});
	 

	 $( '#survey-items-list', $build_list ).sortable({
	    	placeholder: "drop-placeholder",
	    	axis:'y',
	    	forcePlaceholderSize: true,
	    	cursor: 'move',
	    	opacity: 0.7,
	    	revert: 200,
	    	scrollSensitivity: 10,
	    	scrollSpeed: 7,
	    	tolerance: "intersect",
	    	start: function(event, ui) {
	    		//console.log(ui)
	    		if (ui.item.hasClass("new-item")) {

            	}
	        },
	        stop: function(event, ui) {
	        	var _item = ui.item,
	        		item_type = $('button', _item).data('item-type');
	        	console.log(ui)
	            if (ui.item.hasClass("new-item")) {
	            	//ui.sender.draggable("cancel");
	            	console.log('dropped')
                	_item.replaceWith("<li class='survey_item'>" + item_type + "</li>");
            	}
	        },

        	update: function(event, ui) {
        		console.log('updated')
        	}
	    });

	    $( '#survey-items-list', $build_list ).disableSelection();
	    // let the trash be droppable, accepting the gallery items
		




		var itemsHtmlArray ={};// <%#= raw(survey_items_html_array()) %>;

		// document ready 
		$(function(){
			var survey = new Survey({
				survey_id: <%= @survey.id %>,
				survey_update_url: "<%= survey_path(@survey, format: :js) %>",
				total_items: <%= @survey.items.active.count %>,
				itemFormsHtmlArray: itemsHtmlArray,
				trashed_items: <%= @survey.items.trashed.count %>,
				translates: <%= raw translates_for_builder() %>
			});

			$(document).on('click', '#preview-btn', function(){
				window.open("<%= preview_survey_path(@survey) %>",'_blank');
			})

			$(document).on('change', '#theme-select', function(){
				_el = $(this)
				$.ajax({
					url: "<%= survey_path(@survey) %>",
					method: "PUT",
					data: {
						survey: { theme_id: _el.val() }
					},
					success: function(){
						location.reload();
					}
				})
			})
		});
	</script>
<% end %>
